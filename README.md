# Magnetic

## Introduction
This project contains code and configuration examples for setting up the backend and frontend for a PWA CRM using React/Typescript/Vite(PWA) with React Admin (MUI) + Electric SQL on the frontend and Supabase on the backend, all deployable to a Kubernetes cluster via a Kubernetes Helm chart. Local development is supported using `k3d`, allowing to run an isolated, local kubernetes cluster while still taking advantage of the Vite and (Supabase) Deno functions update-on-save (via local mapped volumes and network foo).

It includes an adaptation of the React Admin [`ra-supabase`](https://github.com/marmelab/ra-supabase) demo code (which is itself an adaptation of the React Admin demo CRM) to be used with [`electric-sql`](https://electric-sql.com). The code was originally compatible with `electric` `0.10.1` and `react-admin` but may be updated for later versions.

The kubernetes chart uses the `bitnami` [`supabase`](https://github.com/bitnami/charts/tree/main/bitnami/supabase) (4+) chart as a base for the `supabase` support, adding the missing features as at April 2024 (so `analytics/vector+logflare`, `imgproxy` and `functions`). Hopefully either the `bitnami` chart will eventually include the missing features (don't hold your breath!) or the [`supabase-community`](https://github.com/supabase-community/supabase-kubernetes/) chart will eventually evolve to support multi-node deployments (only support single-node deployments on kubernetes... I know, right!).

This project exists AS AN EXAMPLE usage of the technologies, and has no tests. This is, of course, bad. It has bugs but many such example projects do. If you find any and care, please submit fixes!

## Requirements

This system has been tested on Ubuntu 24.04 but should work on Ubuntu 22.04, either as a host or in Windows WSL2. It may work on other systems.

You must have [`docker`](https://docs.docker.com/engine/install/ubuntu/) (26.1+, only tested with a normal install, not tested with Docker Desktop), [`k3d`](https://k3d.io/) (5.6+), [`kubectl`](https://github.com/kubernetes/kubectl) (1.29+), [`helm`](https://helm.sh/) (3.14+) and [`node`](https://nodejs.org/en) (20.12+) and [`pnpm`](https://pnpm.io/) (9+) installed in their latest versions as of April 2024 and available in your `PATH`. The maintainer uses [`asdf`](https://asdf-vm.com/) (0.14+) for managing node versions but any supported installation method should also work. The maintainer activates/installs `pnpm` via `corepack enable`.

You also need `ca-certificates`, `libnss3-tools`, `libnss-myhostname` and `mkcert`, all of which you should install with `apt install`.

> :warning: **Make sure to run `mkcert -install` (sudo/as root) to enable cert generation before trying to run the scripts below! See below for cert authority info for Windows/WSL2.**

## Installation

### Helm chart

Assuming you do your dev in `~/dev`:

```
git clone git@github.com:AntonOfTheWoods/magnetic.git ~/dev/magnetic
cd ~/dev/magnetic
bash kube/k3d-deploy/k3d-create-cluster.sh && bash kube/k3d-deploy/kubectl-create-secret.sh
bash build-all-push-deploy-local.sh
```

You can check the state of the pods with:

```bash
kubectl --kubeconfig ~/.kube/config.k3d get pods
```

and any `kubectl`/`helm` commands to access the cluster should use `~/.kube/config.k3d` as the `kubeconfig`. You can obviously manage your `kubeconfig` as you see fit (via aliases, etc.), but the scripts will create/update that file, so be warned if you reinstall the `k3d` cluster - you will need to get the config from there again if you are not using that for your commands.

### SSL Certificates

The system uses `supabase.localhost`, `supabase-studio.localhost` and `magnetic.localhost` to access the various services locally by default, and you could easily add configuration to expose the `minio`.

If you are on a Linux host, you should now be Ok - `mkcert` creates certificates in the right place. On Windows, you need to first allow the certificates generated by your `wsl2`. [Follow the instructions here](https://github.com/FiloSottile/mkcert/issues/357#issuecomment-1466762021) to enable this. Basically, you just need to open the certificate authority files in Windows and add them to your cert store, which the linked instructions will help you do.

You will now be able to access your local sites with `https`, and install the PWA like a normal PWA, etc.

### Bootstrapping the database and starting the frontend.

Once you have confirmed that all the kubernetes services have started correctly (via `kubectl --kubeconfig ~/.kube/config.k3d get pods`) and then logging in to `supabase-studio.localhost` to ensure `supabase` is working as expected.

You can then:

```bash
cd ~/dev/magnetic/
pnpm install
pnpm db:migrate  # this will create the tables and electrify them
pnpm db:seed  # this will create the CRM data values and supabase users
```

These commands should finish with no visible errors, and you should now seem some tables and data in `supabase-studio.localhost`.

You can then start the frontend:

```bash
cd ~/dev/magnetic/frontend
pnpm install
pnpm client:generate
sed -i '1s;^;// @ts-nocheck\n;' src/generated/client/index.ts  # hopefully this won't be necessary soon!!!
pnpm dev
```

You can then go to `magnetic.localhost` and log in with `janedoe@atomic.dev`:`password`. You may need to `ctrl+r`/`ctrl+F5` in order to get the data after first login (this is a bug, and will get fixed!).
